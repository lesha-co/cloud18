<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subreddit Network Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #1a1a1a;
        overflow: hidden;
      }

      #graph {
        width: 100vw;
        height: 100vh;
      }

      .node {
        cursor: pointer;
        stroke: #fff;
        stroke-width: 1.5px;
      }

      .node:hover {
        stroke-width: 3px;
      }

      .link {
        stroke: #666;
        stroke-opacity: 0.6;
        stroke-width: 1px;
      }

      .link.multi-link {
        stroke: #8888ff;
        stroke-opacity: 0.8;
        stroke-width: 2px;
      }

      .node-label {
        pointer-events: none;
        font-size: 10px;
        fill: #fff;
        text-anchor: middle;
        dominant-baseline: central;
        text-shadow:
          0 0 3px #000,
          0 0 3px #000;
      }

      #tooltip {
        position: absolute;
        padding: 10px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 5px;
        pointer-events: none;
        display: none;
        font-size: 12px;
        border: 1px solid #444;
      }

      #controls {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 5px;
        color: white;
        font-size: 12px;
      }

      #controls label {
        display: block;
        margin-bottom: 10px;
      }

      #controls input {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="graph"></div>
    <div id="tooltip"></div>
    <div id="controls">
      <label>
        Link Strength:
        <input
          type="range"
          id="linkStrength"
          min="0.1"
          max="2"
          step="0.1"
          value="1"
        />
        <span id="linkStrengthValue">1</span>
      </label>
      <label>
        Charge Force:
        <input
          type="range"
          id="chargeForce"
          min="-500"
          max="-50"
          step="10"
          value="-300"
        />
        <span id="chargeForceValue">-300</span>
      </label>
    </div>

    <script>
      const graphData = %TEMPLATE%;

      // Set up dimensions and margins
      const width = window.innerWidth;
      const height = window.innerHeight;

      // Create SVG
      const svg = d3.select("#graph")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

      // Create a group for zooming
      const g = svg.append("g");

      // Add zoom behavior
      const zoom = d3.zoom()
          .scaleExtent([0.1, 10])
          .on("zoom", (event) => {
              g.attr("transform", event.transform);
          });

      svg.call(zoom);

      // Color based on node type and NSFW status
      const getNodeColor = (d) => {
          if (d.isMulti) {
              return '#4444ff'; // Blue for multi nodes
          }
          return d.meta.nsfw ? '#ff4444' : '#44ff44';
      };

      // Create size scale for nodes based on subscribers (square root scale)
      const maxSubscribers = d3.max(graphData.nodes, d => d.meta?.subs || 0);
      const sizeScale = d3.scaleSqrt()
          .domain([0, maxSubscribers > 0 ? maxSubscribers : 10000])
          .range([5, 40]);

      // Function to get node size based on square root of subscriber count
      const getNodeSize = (d) => {
          if (d.isMulti) {
              // Multi nodes slightly larger to be more visible
              return sizeScale(d.meta.subs) * 1.5;
          }
          const value = d.meta.subs;
          return sizeScale(value);
      };

      // Prepare links for D3 (convert string references to actual node references)
      const linkData = graphData.edges.map(edge => ({
          source: edge.from_subreddit,
          target: edge.to_subreddit,
          value: 1,
          type: edge.type || 'normal'
      }));

      // Create force simulation
      const simulation = d3.forceSimulation(graphData.nodes)
          .force("link", d3.forceLink(linkData)
              .id(d => d.id)
              .distance(d => d.type === 'multi-link' ? 30 : 50 + 10 * Math.sqrt(d.source.degree + d.target.degree))
              .strength(d => d.type === 'multi-link' ? 1.5 : 0.3))
          .force("charge", d3.forceManyBody()
              .strength(d => -150 - 10 * Math.sqrt(d.degree || 1)))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide().radius(d => getNodeSize(d) + 3))
          .force("x", d3.forceX(width / 2).strength(0.02))
          .force("y", d3.forceY(height / 2).strength(0.02));

      // Create links
      const link = g.append("g")
          .selectAll("line")
          .data(linkData)
          .enter().append("line")
          .attr("class", d => d.type === 'multi-link' ? 'link multi-link' : 'link');

      // Create nodes
      const node = g.append("g")
          .selectAll("circle")
          .data(graphData.nodes)
          .enter().append("circle")
          .attr("class", "node")
          .attr("r", d => getNodeSize(d))
          .attr("fill", d => getNodeColor(d))
          .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));

      // Add labels
      const label = g.append("g")
          .selectAll("text")
          .data(graphData.nodes)
          .enter().append("text")
          .attr("class", "node-label")
          .text(d => d.isMulti ? d.id.replace('multi:', 'm:') : d.id)
          .style("font-size", d => Math.max(8, Math.min(getNodeSize(d) * 0.7, 14)) + "px")


      // Tooltip
      const tooltip = d3.select("#tooltip");

      node
          .on("mouseover", (event, d) => {
              // Count connections (matches degree)
              const connections = graphData.edges.filter(l =>
                  l.from_subreddit === d.id || l.to_subreddit === d.id
              ).length;

              const tooltipContent = d.isMulti ?
                  `<strong>Multi: ${d.id.replace('multi:', '')}</strong><br>
                   Subreddits: ${Math.floor(d.meta.subs / 1000)}<br>
                   Connections: ${connections}<br>
                   Degree: ${d.degree}` :
                  `<strong>r/${d.id}</strong><br>
                   Subscribers: ${d.meta.subs.toLocaleString()}<br>
                   NSFW: ${d.meta.nsfw ? 'Yes' : 'No'}<br>
                   Connections: ${connections}<br>
                   Degree: ${d.degree}`;

              tooltip
                  .style("display", "block")
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY - 10) + "px")
                  .html(tooltipContent);
          })
          .on("mouseout", () => {
              tooltip.style("display", "none");
          });

      // Update positions on tick
      simulation.on("tick", () => {
          link
              .attr("x1", d => d.source.x)
              .attr("y1", d => d.source.y)
              .attr("x2", d => d.target.x)
              .attr("y2", d => d.target.y);

          node
              .attr("cx", d => d.x)
              .attr("cy", d => d.y);

          label
              .attr("x", d => d.x)
              .attr("y", d => d.y);
      });

      // Drag functions
      function dragstarted(event) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
      }

      function dragged(event) {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
      }

      function dragended(event) {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
      }

      // Controls
      const linkStrengthSlider = document.getElementById('linkStrength');
      const linkStrengthValue = document.getElementById('linkStrengthValue');
      const chargeForceSlider = document.getElementById('chargeForce');
      const chargeForceValue = document.getElementById('chargeForceValue');

      linkStrengthSlider.addEventListener('input', (e) => {
          const value = e.target.value;
          linkStrengthValue.textContent = value;
          simulation.force("link").strength(+value);
          simulation.alpha(0.3).restart();
      });

      chargeForceSlider.addEventListener('input', (e) => {
          const value = e.target.value;
          chargeForceValue.textContent = value;
          simulation.force("charge").strength(+value);
          simulation.alpha(0.3).restart();
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
          if (e.key === 'r' || e.key === 'R') {
              // Reset zoom
              svg.transition().duration(750).call(
                  zoom.transform,
                  d3.zoomIdentity
              );
          }
      });
    </script>
  </body>
</html>
